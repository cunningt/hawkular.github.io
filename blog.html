<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/asciidoctor.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <link href="css/tabzilla.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/prettify.css" rel="stylesheet">
    <link href="css/ekko-lightbox.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="js/moment.min.js"></script>
    <script src="js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="alternate" href="feed.xml" title="Hawkular Blog - RSS" type="application/rss+xml">

  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">
    <div id="wrap">
      <div class="dropup">
        <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
        <script>
            window.addEventListener('load', function() {
                 renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
        </script>
      </div>

    	<!-- Fixed navbar -->
        <nav class="navbar navbar-fixed-top" role="navigation">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="">Home</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav">
                <li><a href="overview/">Overview</a></li>
                <li><a href="blog.html">Blog</a></li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Services<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li class="menu-item dropdown dropdown-submenu">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="hawkular-services/docs/quickstart-guide/">Quickstart</a>
                        </li>
                        <li class="menu-item ">
                          <a href="hawkular-services/docs/installation-guide/">Installation Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="hawkular-services/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item dropdown dropdown-submenu">
                          <a href="#" class="dropdown-toggle" data-toggle="dropdown">REST API</a>
                          <ul class="dropdown-menu">
                            <li class="menu-item ">
                              <a href="docs/rest/rest-alerts.html">Alerting</a>
                            </li>
                            <li class="menu-item ">
                              <a href="docs/rest/rest-inventory.html">Inventory</a>
                            </li>
                            <li class="menu-item ">
                              <a href="docs/rest/rest-metrics.html">Metrics</a>
                            </li>
                          </ul>
                        </li>
                      </ul>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-services/releases">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular APM<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                      <li><a href="hawkular-apm/">Overview</a></li>
                    </li>
                    <li>
                      <a href="https://hawkular.gitbooks.io/hawkular-apm-user-guide/content/">Documentation</a>
                    </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-apm/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li class="dropdown">
                  <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                    Hawkular Metrics<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="hawkular-metrics/docs/user-guide/">User Guide</a>
                        </li>
                        <li class="menu-item ">
                          <a href="docs/rest/rest-metrics.html">Metrics REST API</a>
                        </li>
                        <li class="menu-item ">
                          <a href="docs/rest/rest-alerts.html">Alerting REST API</a>
                        </li>
                      </ul>
                  </li>
                    <li>
                      <a href="https://github.com/hawkular/hawkular-metrics/releases/">Download</a>
                    </li>
                  </ul>
                </li>
                <li><a href="hawkular-clients/">Hawkular Clients</a></li>
                <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
                  Community
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li>
                    <a href="community/docs/getting-involved/">Getting Involved</a>
                  </li>
                  <li class="menu-item ">
                    <a href="community/docs/developer-guide/">Developer Guide</a>
                  </li>
                  <li class="menu-item dropdown dropdown-submenu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs</a>
                      <ul class="dropdown-menu">
                        <li class="menu-item ">
                          <a href="community/labs/datamining/">Datamining</a>
                        </li>
                        <li class="menu-item ">
                          <a href="https://github.com/pilhuhn/hawkfx">HawkFX</a>
                        </li>
                        <li class="menu-item ">
                          <a href="hawkular-clients/android-client/">Android client</a>
                        </li>
                      </ul>
                  </li>
                  <li>
                    <a href="https://github.com/hawkular">GitHub Repositories</a>
                  <li>
                    <a href="https://travis-ci.org/hawkular">CI Builds</a>
                  </li>
                </ul></li>
              </ul>
            </div>
          </div>
        </nav>


<section class="main-banner blog-mainbanner">
    <div class="container">
        <h1>Hawkular Blog</h1>
    </div>
</section>


<div class="blog-container">
            <a href="blog/2017/01/31/hawkular-services-0.30-released.html"><h1>Hawkular Services 0.30.0.Final</h1></a>
            <p>31 January 2017, by Heiko W. Rupp</p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular services is a ready to run distribution of Hawkular-Metrics with Alerts, Inventory, the WildFly agent and other components.
The version <a href="https://repository.jboss.org/nexus/content/groups/public/org/hawkular/services/hawkular-services-dist/0.30.0.Final/hawkular-services-dist-0.30.0.Final.zip">0.30.0.Final</a> has just been released and is ready to be tested and integrated with other projects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_s_in_this_release">What&#8217;s in this release</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This release includes those changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The WildFly agent now supports EAP 6(.4). See Subtasks of <a href="https://issues.jboss.org/browse/HAWKULAR-1175">HAWKULAR-1175</a></p>
</li>
<li>
<p>An Event is forwarded to subscribed clients (like ManageIQ) when a new WildFly server connects for the first time. See <a href="https://issues.jboss.org/browse/HAWKULAR-1188">HAWKULAR-1188</a></p>
</li>
<li>
<p>Number of threads created by ActiveMQ are now limited to 30 to prevent start issues by running into file descriptor limits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hawkular Services is released every week on Tuesdays.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started">Get started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get started with Hawkular Services, <a href="https://repository.jboss.org/nexus/content/groups/public/org/hawkular/services/hawkular-services-dist/0.30.0.Final/hawkular-services-dist-0.30.0.Final.zip">download the latest release</a>, unzip it,
add a user and set the Agent to use the credentials for the user just added.</p>
</div>
<div class="paragraph">
<p>It can be accomplished with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">export HAWKULAR_HOME="/path/to/hawkular-services"
export HAWKULAR_USERNAME="jdoe"
export HAWKULAR_PASSWORD="password"

cd "${HAWKULAR_HOME}"
"${HAWKULAR_HOME}/bin/add-user.sh" \
  -a \
  -u "${HAWKULAR_USERNAME}" \
  -p "${HAWKULAR_PASSWORD}" \
  -g read-write,read-only
"${HAWKULAR_HOME}/bin/standalone.sh" -Dhawkular.rest.user="${HAWKULAR_USERNAME}" -Dhawkular.rest.password="${HAWKULAR_PASSWORD}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before starting the server, you need to have Cassandra 3.0.9 up and running with the RPC port enabled either via
setting the env variable of <code>CASSANDRA_START_RPC</code> to <code>true</code></p>
</div>
<div class="paragraph">
<p>or by editing <code>cassandra.yml</code> and setting it there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml"># Whether to start the thrift rpc server.
start_rpc: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>ccm</code> you can use this to update the config: <code>ccm updateconf 'start_rpc: true'</code>.
Another option is via <code>nodetool enablethrift</code>.</p>
</div>
<div class="sect2">
<h3 id="_using_postgres">Using Postgres</h3>
<div class="paragraph">
<p>To use Postgres as backend you need to pass additional properties to the <code>standalone.sh</code> command
above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">"${HAWKULAR_HOME}/bin/standalone.sh" -Dhawkular.rest.user="${HAWKULAR_USERNAME}" \
    -Dhawkular.rest.password="${HAWKULAR_PASSWORD} \
    -Dhawkular.inventory.sql.jdbc.url=jdbc:postgresql://1.2.3.4:5432/hawkular \
    -Dhawkular.inventory.sql.jdbc.username=jdoe \
    -Dhawkular.inventory.sql.jdbc.password=password</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use a postgres database called <em>hawkular</em> on host <em>1.2.3.4</em> owned by a user <em>jdoe</em> with a
 password of <em>password</em>.</p>
</div>
<div class="paragraph">
<p>See also
<a href="http://www.hawkular.org/hawkular-services/docs/user-guide/inventory/index.html#configuration-properties" class="bare">http://www.hawkular.org/hawkular-services/docs/user-guide/inventory/index.html#configuration-properties</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_build_from_master_and_cassandra">Build from master and Cassandra</h3>
<div class="paragraph">
<p>If you build from master, you can pass <code>-Pembeddedc</code> to get a distribution with embedded Cassandra for local development.
Similarly if you build via <code>-Pdev</code> a default user of <em>jdoe/password</em> will be installed and also be used with the agent.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_grafana_with_hawkular_services">Use Grafana with Hawkular-services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We do now have a Grafana datasource to make it easier to connect to Hawkular-services from Grafana.
You can download it from <a href="https://grafana.net/plugins/hawkular-datasource">Grafana.net</a>.
The <a href="https://github.com/hawkular/hawkular-grafana-datasource">website of the datasource tells more</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started_via_inofficial_docker_builds">Get started via (inofficial) Docker builds</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are inofficial Docker images of the release and also an instrumented WildFly available on
DockerHub at <a href="https://hub.docker.com/r/pilhuhn/hawkular-services/">Hawkular services</a>
and <a href="https://hub.docker.com/r/pilhuhn/hawkfly/">Instrumented WildFly</a>.</p>
</div>
<div class="paragraph">
<p>Both images have been instrumented with the <em>jdoe/password</em> user for the Hawkular server and the agent.</p>
</div>
<div class="paragraph">
<p>See also <a href="http://pilhuhn.blogspot.de/2016/06/using-hawkular-services-via-docker.html" class="bare">http://pilhuhn.blogspot.de/2016/06/using-hawkular-services-via-docker.html</a> on some more
details about using those images.</p>
</div>
</div>
</div></p>
            <br />
            <hr /><br />
            <br />
            <a href="blog/2017/01/27/hosa-status.html"><h1>Getting the status of Hosa</h1></a>
            <p>27 January 2017, by Heiko W. Rupp</p>
            <p><div class="sect1">
<h2 id="_getting_the_status_of_the_hawkular_openshift_agent">Getting the status of the Hawkular OpenShift Agent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a previous blog post I talked about the <a href="http://www.hawkular.org/blog/2017/01/17/obst-hosa.html">Hawkular OpenShift Agent and how to use it to monitor Microservices</a>.</p>
</div>
<div class="paragraph">
<p>While setting up the agent and the config maps is not complicated, it is always possible to make a typo. Hosa luckily has a status endpoint that exposes what it is currently doing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/1-hosa-status.png" alt="Status in browser">
</div>
<div class="title">Figure 1. Status display in browser</div>
</div>
<div class="paragraph">
<p>The endpoint is secured by basic authentication. We will see below how to set this up.</p>
</div>
<div class="sect2">
<h3 id="_exposing_the_hosa_status_endpoint">Exposing the Hosa status endpoint</h3>
<div class="paragraph">
<p>It is possible to expose the agent&#8217;s status endpoint, which is deployed as a pod only, as service and with a route to be able to visit the <code>/status</code> url of it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
When you have checked out the agent source code and deployed the agent via <code>make openshift-deploy</code> you can skip the following, as the make command already did the setup.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will create a Yaml definition for the service and route and also a secret.</p>
</div>
<div class="listingblock">
<div class="title">Definition for service and route, <code>hosa-service-route.yml</code></div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: Service
metadata:
  name: hawkular-openshift-agent
  labels:
    metrics-infra: agent
spec:
  ports:
    - protocol: TCP
      port: 8080 <b class="conum">(1)</b>
  selector:
    name: hawkular-openshift-agent
---
apiVersion: v1
kind: Route
metadata:
  name: hosa
  namespace: openshift-infra
  labels:
    metrics-infra: agent
spec:
  path: /status <b class="conum">(2)</b>
  to:
    kind: Service
    name: hawkular-openshift-agent
    weight: 100
---
apiVersion: v1
kind: Secret
metadata:
  name: hawkular-openshift-agent-status
    labels:
      metrics-infra: agent
  data:
    username: ZGV2  <b class="conum">(3)</b>
    password: Y2hhbmdlbWU= <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Expose port 8080</p>
</li>
<li>
<p>Put the status endpoint in the url, so that it opens when clicking in the OpenShift console</p>
</li>
<li>
<p>Username <em>dev</em> as base64</p>
</li>
<li>
<p>Password <em>changeme</em> as base64</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can then deploy this into OpenShift via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ oc project openshift-infra
$ oc create -f hosa-service-route.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>OpenShift will then expose a route in the format <code><a href="http://hosa-openshift-infra.&lt;nodeip&gt;.xip.io/status" class="bare">http://hosa-openshift-infra.&lt;nodeip&gt;.xip.io/status</a></code>.</p>
</div>
<div class="paragraph">
<p>When you navigate to it then you will be prompted for basic authentication. In above example use <em>dev/changeme</em> for the credentials.</p>
</div>
<div class="sect3">
<h4 id="_using_a_different_password_above">Using a different password above</h4>
<div class="paragraph">
<p>When you want to use a different password in the above, you have to supply it in Base64-encoding</p>
</div>
<div class="listingblock">
<div class="title">Base64 encoding of the password</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ echo -n "test4hawkular" | base64
dGVzdDRoYXdrdWxhcgo== <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Copy this onto the password line of <code>hosa-service-route.yml</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_use_a_different_password_later_on">Use a different password later on</h3>
<div class="paragraph">
<p>When you have already installed the secret and want to change the password, you need to delete and re-create the secret with the new values:</p>
</div>
<div class="listingblock">
<div class="title">Install the new password</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc project openshift-infra
$ oc delete secret hawkular-openshift-agent-status
$ oc secret new-basicauth hawkular-openshift-agent-status \ <b class="conum">(1)</b>
    --username=dev \
    --password=changeme2 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the secret</p>
</li>
<li>
<p>New password. No Base64 encoding is needed; OpenShift will take care.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Unfortunately this is not enough as OpenShift does not trigger reloads of pods upon changes of secrets (unlike e.g. for ConfigMaps), so we have to explicitly terminate the running agent to have a new instance pick up the new secret:</p>
</div>
<div class="listingblock">
<div class="title">Make the agent pick up the new password</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ oc project openshift-infra
$ oc get pods | grep agent
hawkular-openshift-agent-upubo   1/1       Running     0          2m
$ oc delete pod hawkular-openshift-agent-upubo
pod "hawkular-openshift-agent-upubo" deleted</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lets_have_a_look_at_the_output">Lets have a look at the output</h3>
<div class="paragraph">
<p>Now let&#8217;s have a quick look at the output of the status endpoint. I will use the <code>curl</code> command for this. The output is similar to what is shown in Figure1 above.</p>
</div>
<div class="listingblock">
<div class="title">Get the status</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ curl -u dev:changeme2 http://hawkular-openshift-agent-openshift-infra.172.31.7.9.xip.io/status
name: Hawkular OpenShift Agent
version: 1.0.1.Final-SNAPSHOT <b class="conum">(1)</b>
commit_hash: 4655b5cb8363b046e80c052c5fe08723770088ea
pods: <b class="conum">(2)</b>
  172.31.7.9/openshift-infra/hawkular-openshift-agent-omf3r/7d48d137-e2ec-11e6-89b4-00219b3e7e23:
  - openshift-infra/hawkular-openshift-agent-omf3r|http://172.17.0.2:8080/metrics
  172.31.7.9/myproject/obs-demo-3-x9hkg/9ad38a87-e3e5-11e6-a3c6-00219b3e7e23:
  - myproject/obs-demo-3-x9hkg|https://172.17.0.6:8778/jolokia/
endpoints: <b class="conum">(3)</b>
  openshift-infra/hawkular-openshift-agent-omf3r|http://172.17.0.2:8080/metrics: OK.
    Last collection at [Wed, 25 Jan 2017 13:56:58 +0000] gathered [22] metrics in
    [2.940328ms]
myproject/obs-demo-3-x9hkg|https://172.17.0.6:8778/jolokia/: 'Failed to collect
    metrics from [myproject/obs-demo-3-x9hkg|https://172.17.0.6:8778/jolokia/] at
    [Thu, 25 Jan 2017 13:57:06 +0000]. err=Failed to collect metrics from Jolokia
    endpoint [https://172.17.0.6:8778/jolokia/]. err=Post https://172.17.0.6:8778/jolokia/:
    x509: cannot validate certificate for 172.17.0.6 because it doesn''t contain any
    IP SANs' <b class="conum">(4)</b>
log: <b class="conum">(5)</b>
- 'Wed, 25 Jan 2017 11:53:29 +0000: STOP collection: openshift-infra/hawkular-openshift-agent-omf3r|http://172.17.0.2:8080/metrics'
- 'Wed, 25 Jan 2017 11:53:29 +0000: START collection: openshift-infra/hawkular-openshift-agent-omf3r|http://172.17.0.2:8080/metrics'
[source,java]
[...]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Version of the agent (and the commit hash it was built from)</p>
</li>
<li>
<p>List of pods it is monitoring with the endppoint it talks to</p>
</li>
<li>
<p>List of endpoints it monitors + result of last collection</p>
</li>
<li>
<p>This one shows an error because the endpoint is on https, but the certificate check fails and we have not disabled this check</p>
</li>
<li>
<p>Latest log messages of the agent.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
When you have the agent source  <a href="https://github.com/hawkular/hawkular-openshift-agent">checked out from git</a>, you can just run <code>make openshift-status</code> instead of the <code>curl</code> command shown above.
</td>
</tr>
</table>
</div>
</div>
</div>
</div></p>
            <br />
            <hr /><br />
            <br />
            <a href="blog/2017/01/17/obst-hosa.html"><h1>Monitoring Microservices on OpenShift with HOSA</h1></a>
            <p>17 January 2017, by Heiko W. Rupp</p>
            <p><div class="sect1">
<h2 id="_monitoring_microservices_on_openshift_with_the_hawkular_openshift_agent">Monitoring Microservices on OpenShift with the Hawkular OpenShift Agent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Monitoring Microservices on orchestrated platforms like OpenShift is a very different endeavor than the classical monitoring of monoliths on their dedicated servers. The biggest two differences are that the services can just be deployed by the schedule on any available server node and that it is possible to have many instances of a single service run in parallel</p>
</div>
<div class="paragraph">
<p>The Hawkular project is now introducing the Hawkular OpenShift Agent (HOSA), which is deployed in OpenShift as infrastructure level component. Hosa runs on each node to monitor pods for the node and sends the retrieved metrics to Hawkular-Metrics. Hosa may eventually replace Heapster in the longer run.</p>
</div>
<div class="sect2">
<h3 id="_the_monitoring_scenario">The monitoring scenario</h3>
<div class="paragraph">
<p>The following drawing shows the scenario that I am going to describe below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/OBST-Monitoring-HOSA.png" alt="Scenario overview">
</div>
<div class="title">Figure 1. The Scenario</div>
</div>
<div class="paragraph">
<p>The numbers in the round blue circles will be referenced below as <em>(n)</em>.</p>
</div>
<div class="paragraph">
<p>As example we are taking Microservices created by the <a href="https://github.com/obsidian-toaster">Obsidian Toaster</a> generators and deploy them with the help of the <a href="https://github.com/fabric8io/fabric8-maven-plugin">Fabric8 Maven Plugin</a> into OpenShift.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is not necessary to retrieve the source code from Obsidian Toaster. Any source that can be
deployed to OpenShift via the Fabric8 Maven plugin will do.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After getting the source code from the generator, run the respective
<code>mvn clean package</code> goals as described in the README of the source <em>(1)</em>. If that works well, you can then deploy the result into OpenShift via <code>mvn fabric8:deploy -Popenshift</code> <em>(2)</em>. This will create a so called Source to Image (S2I) build in OpenShift which takes the provided artifacts and config files, creates images and deploys them in a pod with associated service etc <em>(3)</em>.</p>
</div>
<div class="paragraph">
<p>The latter is driven by some internal settings of the maven plugin, which also merges in files from <code>src/main/fabric8/</code>. More on that below.</p>
</div>
<div class="paragraph">
<p>For each JVM that the Fabric8 plugin deploys, it also puts a <a href="https://jolokia.org">Jolokia</a> agent in the VM, as you can see in <em>(3)</em>. This agent exposes internal JMX metrics via the Jolokia-REST protocol, on a pre-defined port with a default user name and a random password. The data of this pod is also exposed via the API-proxy, so that you can click on the <em>Open Java Console</em> link in the next figure to get to a JMX browser.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/OBST-Pod.png" alt="Pod in Openshift">
</div>
<div class="title">Figure 2. A pod in OpenShift</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_hawkular_openshift_agent">The Hawkular OpenShift Agent</h3>
<div class="paragraph">
<p>The <a href="https://github.com/hawkular/hawkular-openshift-agent">Hawkular OpenShift Agent</a> (Hosa) runs as part of the OpenShift infrastructure inside the <em>openshift-infra</em> namespace on a per node basis, monitoring eligible pods on that node. The GitHub page has pretty good information on how to compile and deploy it (there are also pre-created Docker images available).</p>
</div>
<div class="paragraph">
<p>In order for Hosa to know which pods to monitor and what metrics to collect, it looks at pods and checks if they have a <em>ConfigMap</em> with a name of <code>hawkular-openshift-agent</code> declared.</p>
</div>
<div class="listingblock">
<div class="title">Config Map for Hosa, <em>(4)</em></div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">kind: ConfigMap
apiVersion: v1
metadata:
  name: obs-java-hosa-config.yml  <b class="conum">(1)</b>
  namespace: myproject
data:
  hawkular-openshift-agent: | <b class="conum">(2)</b>
    endpoints:
    - type: jolokia <b class="conum">(3)</b>
      collection_interval: 60s <b class="conum">(4)</b>
      protocol: "https"
      tls:
        skip_certificate_validation: true <b class="conum">(5)</b>
      port: 8778
      credentials:
        username: jolokia
        password: secret:hosa-secret/password  <b class="conum">(6)</b>
      path: /jolokia/
      tags:
        name: ${POD:label[project]} <b class="conum">(7)</b>
      metrics: <b class="conum">(8)</b>
      - name: java.lang:type=Threading#ThreadCount
        id: the_thread_count
        type: gauge</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the map</p>
</li>
<li>
<p>Configuration for the agent to monitor matching pods</p>
</li>
<li>
<p>This is a Jolokia-kind of endpoint</p>
</li>
<li>
<p>Collect the metrics every 60s. This is a Golang Duration and is equal to <code>1m</code></p>
</li>
<li>
<p>The agent checks for valid certificates in case of https. We skip this check</p>
</li>
<li>
<p>This is the password used to talk to Jolokia, which we obtain from a <em>secret</em>&#8201;&#8212;&#8201;more below.</p>
</li>
<li>
<p>Each metric is tagged with a label <code>name=&lt;project name&gt;</code></p>
</li>
<li>
<p>Definition of the metrics to be collected</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can save the above ConfigMap into a file and deploy it into Openshift via <code>oc create -f &lt;configmap.yml&gt;</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Hosa can also grab data from Prometheus style endpoints. In the future we may switch to use this protocol, as JMX is a very JavaVM-centric concept and Microservices may also be created in non-JVM environments like Node.js or Ruby.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now the question is how do we tell our deployment to use this config map? In Figure 2 you see, that this gets declared as a volume. In order to do so, we need to go back to our local source code and add a new file <code>deployment.yml</code> into <code>src/main/fabric8/</code> and re-deploy our source with <code>mvn package fabric8:deploy -Popenshift</code>. And as we are doing this, we also want to make sure that the password for Jolokia is not hard coded, but will be obtained from an OpenShift <em>secret</em></p>
</div>
<div class="listingblock">
<div class="title">deployment.yml</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml"># This gets merged into the main openshift.yml's deployment config via f8 plugin
spec:
  template:
    spec:
      volumes:
        - name: hawkular-openshift-agent <b class="conum">(1)</b>
          configMap:
            name: obs-java-hosa-config.yml <b class="conum">(2)</b>
      containers:
        - env:
          - name: AB_JOLOKIA_PASSWORD_RANDOM <b class="conum">(3)</b>
            value: "false"
          - name: AB_JOLOKIA_PASSWORD <b class="conum">(4)</b>
            valueFrom:
              secretKeyRef: <b class="conum">(5)</b>
                name: hosa-secret
                key: password</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The magic name of the volume so that Hosa can find it</p>
</li>
<li>
<p>The name of the config map to use. See (1) in <em>Config Map for Hosa</em> above.</p>
</li>
<li>
<p>Tell Jolokia not to create a random password</p>
</li>
<li>
<p>Make OpenShift set the password, which it gets from a <em>secret</em></p>
</li>
<li>
<p>The secret to query is named <em>hosa-secret</em> and we want the entry with the name <em>password</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Hosa is getting noticed once you redeploy the application, and will see the volume and will try to start monitoring the pod. Which leaves us with the OpenShift <em>secret</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
OpenShift will be stuck in state of "Creating Container" until the secret is added, as it can otherwise not inject the secret&#8217;s value into the environment of the container. Unfortunately it does not tell this and just seem to hang.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_creating_the_secret_em_5_em">Creating the secret, <em>(5)</em></h4>
<div class="paragraph">
<p>To create a secret that holds our password we need to do two things. First we need to encode the password in base 64 format.</p>
</div>
<div class="listingblock">
<div class="title">Base64 encoding of the password</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ echo -n "test4hawkular" | base64
dGVzdDRoYXdrdWxhcgo==</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we need to create a yml file for the secret.</p>
</div>
<div class="listingblock">
<div class="title">hosa-secret.yml</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: Secret
metadata:
  name: hosa-secret <b class="conum">(1)</b>
type: Opaque
data:
  password: dGVzdDRoYXdrdWxhcg== <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the secret</p>
</li>
<li>
<p>Key is 'password', value is password from previous step</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can deploy that secret with <code>oc create -f hosa-secret.yml</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_display_data_with_grafana">Display data with Grafana</h3>
<div class="paragraph">
<p>Now that we have the agent collecting data and storing in Hawkular-Metrics we can look at them with the help of Grafana.
Joel Takvorian has <a href="http://www.hawkular.org/blog/2016/10/24/hawkular-metrics-openshift-and-grafana.html">described this pretty well</a>, so I am not going to repeat the setup in detail here.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
To get quickly started, you can run <code>$ oc new-app docker.io/hawkular/hawkular-grafana-datasource</code>. And then when the service is created, click on <em>Add route</em> in the OpenShift UI to expose Grafana to the outside world.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure the datasource in Grafana, we can now use the namespace of the project and a token</p>
</div>
<div class="listingblock">
<div class="title">Getting host, tenant and token to configure the datasource</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ oc whoami
developer
$ oc project
Using project "myproject" on server "https://pintsize:8443". <b class="conum">(1)</b>
$ oc whoami -t
JhrqvcFTnEuP3XRPrLbwAAfpbZV4hYmne3-JMIXv4LQ <b class="conum">(2)</b>
$ oc login -u system:admin <b class="conum">(3)</b>
$ oc get svc hawkular-metrics -n openshift-infra <b class="conum">(4)</b>
NAME               CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
hawkular-metrics   172.30.236.16   &lt;none&gt;        443/TCP   12d <b class="conum">(5)</b>
# This is an alternative
$ oc get route hawkular-metrics -n openshift-infra <b class="conum">(6)</b>
NAME               HOST/PORT
hawkular-metrics   metrics-openshift-infra.172.31.7.9.xip.io</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>'myproject' will be the tenant</p>
</li>
<li>
<p>The token for authentication</p>
</li>
<li>
<p>OpenShift infrastructure is not visible to the developer account</p>
</li>
<li>
<p>Get the Cluster-IP of the Hawkular-Metrics service</p>
</li>
<li>
<p>Cluster-IP is the host part of the https url of the metrics service, which follows the pattern of <code><a href="https://&lt;cluster-ip&gt;/hawkular/metrics" class="bare">https://&lt;cluster-ip&gt;/hawkular/metrics</a></code></p>
</li>
<li>
<p>As alternative get the public host from the OpenShift route</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can then use this information to define our datasource in Grafana. If you want you can also make this the default by ticking the respective checkbox. Access mode needs to be proxy, as the service is not visible (under that IP) from outside of OpenShift. Instead of using the OpenShift-internal service we can also use the external IP defined by the hawkular-metrics route.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/OBST-Grafana-Datasource.png" alt="Grafana datasource setup">
</div>
<div class="title">Figure 3. Grafana datasource setup</div>
</div>
<div class="paragraph">
<p>Using a token works well and is quickly done, but it has the caveat that tokens obtained with <code>oc whoami -t</code> will expire and thus should only be used to quickly test if the datasource works.</p>
</div>
<div class="paragraph">
<p>A better solution is to use a service account <em>(7)</em> instead of the token, which I am going to explain next.</p>
</div>
<div class="sect3">
<h4 id="_create_a_service_account_em_7_em">Create a service account, <em>(7)</em></h4>
<div class="paragraph">
<p>Creating a Service Account is easy and can be done via <code>oc create sa view-metrics</code></p>
</div>
<div class="paragraph">
<p>When you look at it with <code>oc describe sa/view-metrics</code>, it shows a list of tokens at the end:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-shell" data-lang="shell">$ oc describe sa/view-metrics
Name:		view-metrics
Namespace:	myproject
Labels:		&lt;none&gt;

Image pull secrets:	view-metrics-dockercfg-rmnee

Mountable secrets: 	view-metrics-dockercfg-rmnee
                   	view-metrics-token-vowtw

Tokens:            	view-metrics-token-t98qw <b class="conum">(1)</b>
                   	view-metrics-token-vowtw</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The token to be used in the next step</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Those tokens are actually secrets, that were populated by OpenShift. Inspecting one of the tokens then reveals a token string, that we can use inside of Grafana</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Only the Token, which is not the one, that is also listed as mountable secret can be used. The other one will not work and Grafana will report a "Forbidden" message when trying to save the datasource.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc describe secret view-metrics-token-t98qw
Name:		view-metrics-token-vowtw
Namespace:	myproject
Annotations:    kubernetes.io/created-by=openshift.io/create-dockercfg-secrets
                kubernetes.io/service-account.name=view-metrics <b class="conum">(1)</b>
[...]
Data
====
namespace:	9 bytes
service-ca.crt:	2186 bytes
token:		eyJhbGciOiJS... <b class="conum">(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This annotation needs to be present for the secret to be usable</p>
</li>
<li>
<p>Long token string</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/OBST-Grafana1.png" alt="Using the token from the ServiceAccount">
</div>
<div class="title">Figure 4. Using the token from the ServiceAccount</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_result">Result</h3>
<div class="paragraph">
<p>So finally we can see the thread count of our Obsidian sample application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/OBST-Grafana-ThreadCount.png" alt="Thread count">
</div>
<div class="title">Figure 5. Thread count in Grafana</div>
</div>
<div class="paragraph">
<p>In the chart we can now see the thread count of our application. You can see that at around 9am we scaled the app from one to two pods.</p>
</div>
</div>
</div>
</div></p>
            <br />
            <hr /><br />
            <br />
            <a href="blog/2017/01/16/hawkular-metrics-with-dropwizard.html"><h1>Reporting Dropwizard metrics to Hawkular</h1></a>
            <p>16 January 2017, by Joel Takvorian</p>
            <p><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Dropwizard metrics</em> (aka. Codahale aka. Yammer) is a well known, successful metrics framework that is easy to plug in a Java application.
You just create a metrics registry, create metrics, feed them and voilà.
But Dropwizard metrics doesn&#8217;t store anything by itself, it&#8217;s delegated to the so-called "reporters".
So we&#8217;ve built the <a href="https://github.com/hawkular/hawkular-dropwizard-reporter"><em>hawkular-dropwizard-reporter</em></a>.</p>
</div>
<div class="paragraph">
<p>This article will show you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>how you can create custom metrics</p>
</li>
<li>
<p>how you can take advantage of existing middleware that uses Dropwizard metrics</p>
</li>
<li>
<p>how to fine-tune the Hawkular reporter to make data exploitation easy</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an example, I will use a very simple application to benchmark some data structures (caches) in real time, and output results as metrics.
This is not a serious benchmark and we don&#8217;t really care about the results: our purpose is nothing more than to illustrate how we can work with Hawkular and Dropwizard.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-01-16-dropwizard-sample-overview.png" alt="Overview">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_minimal_setup">Minimal setup</h3>
<div class="paragraph">
<p>You need very few things to start using the Hawkular Dropwizard reporter. Obviously, you must have a running instance of <em>Hawkular Metrics</em>. If you don&#8217;t have it yet, check out the <a href="http://www.hawkular.org/hawkular-services/docs/installation-guide/">installation guide</a>.</p>
</div>
<div class="paragraph">
<p>Then, add a <em>maven</em> dependency to your Java application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
        &lt;groupId&gt;org.hawkular.metrics&lt;/groupId&gt;
        &lt;artifactId&gt;hawkular-dropwizard-reporter&lt;/artifactId&gt;
        &lt;version&gt;0.1.1&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In your Java code, create a <em>MetricRegistry</em> and pass it to the <em>HawkularReporter</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    MetricRegistry registry = new MetricRegistry();
    HawkularReporter hawkularReporter = HawkularReporter.builder(registry, "sample-tenant")
            .build();
    hawkularReporter.start(1, TimeUnit.SECONDS);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. From now on, all metrics that are added to the registry will be reported to Hawkular Metrics.
The default configuration expects to find the Hawkular server on <em>localhost:8080</em>, you can change it with the builder&#8217;s <code>uri</code> method. You can <a href="https://github.com/hawkular/hawkular-dropwizard-reporter#other-builder-options">explore the builder options</a> to configure it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
In this example, "sample-tenant" refers to the tenant used in Hawkular. You can set whatever you want instead. <a href="http://www.hawkular.org/hawkular-metrics/docs/user-guide/#_tenants">Check Hawkular documentation</a> to learn more about multi-tenancy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If, for instance, we want to connect to an Hawkular pod running in OpenShift, we would configure the reporter similar to that one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    HawkularReporter hawkularReporter = HawkularReporter.builder(registry, "sample-tenant")
            .uri("https://metrics.192.168.42.63.xip.io/hawkular/metrics")
            .bearerToken("ABCDEFGHIJ1234")
            .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To conclude with the initial setup, note that it is often a good practice to include some host-based disambiguation string in the metric names,
so that if your application is deployed on several hosts and they all communicate to the same Hawkular instance using the same tenant,
they will not conflict and feed the same metrics.
A convenient way to do that is to set a prefix in the reporter configuration, for instance using the host name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    String hostname;
    try {
        hostname = InetAddress.getLocalHost().getCanonicalHostName();
    } catch (UnknownHostException e) {
        hostname = "?";
    }
    HawkularReporter hawkularReporter = HawkularReporter.builder(registry, "sample-tenant")
            .prefixedWith(hostname + ".")
            .build();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dropwizard_hawkular">Dropwizard &#8594; Hawkular</h3>
<div class="paragraph">
<p>As stated before, our sample app will do some (very) basic benchmarking on several caches implementations: we&#8217;ll have a <em>Guava</em> cache and a local <em>EhCache</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This sample app is on my GitHub: <a href="https://github.com/jotak/hawkular-dropwizard-sample" class="bare">https://github.com/jotak/hawkular-dropwizard-sample</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We create a very simple interface that allows us to get data from cache, count number of elements and know if the latest read was from cache or not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">interface Backend {
    Object get(String key);
    long count();
    void init(Map&lt;String, Object&gt; presetElements);
    boolean isLastReadFromCache();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can <a href="https://github.com/jotak/hawkular-dropwizard-sample/tree/master/src/main/java/com/hawkular/sample">see on GitHub</a> the <code>GuavaBackend</code> and <code>EhcacheBackend</code> implementations, there&#8217;s nothing fancy here.</p>
</div>
<div class="paragraph">
<p>EhCache is initialized programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    CacheManager cacheManager = CacheManager.newInstance();
    Ehcache cache = cacheManager.addCacheIfAbsent("testCache");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, the <code>Benchmark</code> class. This is where we create metrics and feed them, with the pretext of a small scenario. Here&#8217;s the <code>run</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    private void run() {
        final DatabaseStub fakeDb = new DatabaseStub(); <b class="conum">(1)</b>
        final BackendMonitoring monitoring = new BackendMonitoring(registry); <b class="conum">(2)</b>
        Map&lt;String, Object&gt; presetElements = IntStream.range(0, 100000)
                .mapToObj(Integer::new)
                .collect(Collectors.toMap(i -&gt; UUID.randomUUID().toString(), i -&gt; i)); <b class="conum">(3)</b>

        <b class="conum">(4)</b>
        monitoring.runScenario(presetElements, new GuavaBackend(fakeDb), GuavaBackend.NAME);
        monitoring.runScenario(presetElements, new EhcacheBackend(fakeDb, ehcache), EhcacheBackend.NAME);
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The class <code>DatabaseStub</code> is used to simulate a database with latency, using just a <code>HashMap</code> for storage (<a href="https://github.com/jotak/hawkular-dropwizard-sample/blob/master/src/main/java/com/hawkular/sample/DatabaseStub.java">view it on GitHub</a>).</p>
</li>
<li>
<p><code>BackendMonitoring</code> will setup monitoring for a given backend.</p>
</li>
<li>
<p>Creates a collection of items to store in cache, and use them in the scenarios.</p>
</li>
<li>
<p>Run the scenario for each <code>Backend</code> implementation (described below).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, <code>BackendMonitoring.runScenario</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    void runScenario(Map&lt;String, Object&gt; presetElements, Backend backend, String name) {
        System.out.println("Starting scenario for " + name);
        registry.register(name + ".size", (Gauge&lt;Long&gt;) backend::count); <b class="conum">(1)</b>
        Timer readTimer = registry.timer(name + ".read"); <b class="conum">(2)</b>
        final Meter readCacheMeter = registry.meter(name + ".cache.read"); <b class="conum">(3)</b>
        final Meter readDbMeter = registry.meter(name + ".db.read"); <b class="conum">(4)</b>
        final Counter numberItemsRead = registry.counter(name + ".total.read.count"); <b class="conum">(5)</b>
        // Setup preset elements
        backend.init(presetElements);
        List&lt;String&gt; keys = new ArrayList&lt;&gt;(presetElements.keySet());
        ThreadLocalRandom rnd = ThreadLocalRandom.current();
        Stopwatch watch = Stopwatch.createStarted();
        while (watch.elapsed(TimeUnit.MINUTES) &lt; 5) {
            int pos = rnd.nextInt(0, keys.size());
            runWithBenchmark(() -&gt; {
                backend.get(keys.get(pos));
                if (backend.isLastReadFromCache()) {
                    readCacheMeter.mark();
                } else {
                    readDbMeter.mark();
                }
                numberItemsRead.inc();
            }, readTimer);
        }
        // Reset size gauge to 0
        backend.init(new HashMap&lt;&gt;());
        System.out.println("Ending scenario for " + name);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally, <code>BackendMonitoring.runWithBenchmark</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    private void runWithBenchmark(Runnable r, Timer readTimer) {
        final Timer.Context ctx = readTimer.time();
        try {
            r.run();
        } finally {
            ctx.stop();
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we create several metrics:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A <em>Gauge</em> that will track the number of elements in cache.</p>
</li>
<li>
<p>A <em>Timer</em> metric. Each time the <code>runWithBenchmark</code> method is called, that timer computes the <code>Runnable</code> execution time.</p>
</li>
<li>
<p>A <em>Meter</em> that is invoked each time data is read from cache (rather than DB).</p>
</li>
<li>
<p>The opposite: a <em>Meter</em> that is invoked each time data is read from db.</p>
</li>
<li>
<p>A <em>Counter</em> that tracks the total number of reads. We could actually get rid of it, because its value could be retrieved from readDbMeter.count + readCacheMeter.count (yes, a <em>Meter</em> includes a <em>Counter</em>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can learn more about <em>Dropwizard</em> metric types <a href="http://metrics.dropwizard.io/3.1.0/getting-started/">from its documentation</a>.</p>
</div>
<div class="paragraph">
<p>Remember that since we associated the Hawkular reporter with the metrics registry, all metrics are automatically reported into <em>Hawkular Metrics</em>.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s run the benchmark. I&#8217;m using <a href="http://grafana.org/">Grafana</a> with its <a href="https://grafana.net/plugins/hawkular-datasource">Hawkular plugin</a> to display graphs.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-01-16-dropwizard-sample-metrics.png" alt="Custom metrics">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Upper-left: storage size (yellow = Guava, green = EhCache)</em></p>
</li>
<li>
<p><em>Upper-right: read response time (yellow = Guava, green = EhCache)</em></p>
</li>
<li>
<p><em>Bottom-left: read cache vs DB - mean rate (orange = Guava/db, yellow = Guava/cache, blue = EhCache/db, green = EhCache/cache)</em></p>
</li>
<li>
<p><em>Bottom-right: read cache vs DB - count (orange = Guava/db, yellow = Guava/cache, blue = EhCache/db, green = EhCache/cache)</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can see the Guava cache scenario in the first 5 minutes, followed by the EhCache scenario.
Note how the storage size fells abruptly at about halfway of EhCache scenario: this is probably due to a cache eviction mechanism that is present by default (given we didn&#8217;t configure the cache at all).</p>
</div>
<div class="paragraph">
<p>We can correlate that with the response time with EhCache that is not improving as fast as Guava&#8217;s as long as the cache get filled. However we can suppose it&#8217;s compensated for smaller memory footprint.</p>
</div>
</div>
<div class="sect2">
<h3 id="_middleware_dropwizard_hawkular">Middleware &#8594; Dropwizard &#8594; Hawkular</h3>
<div class="paragraph">
<p>So, we know how to create metrics. That&#8217;s perfect to track values that are very specific to an application.
But the best is that a lot of existing Java middleware already provides tons of metrics on Dropwizard, that you can integrate very easily in your application.</p>
</div>
<div class="paragraph">
<p>There is a non exhaustive list in Dropwizard documentation (<a href="http://metrics.dropwizard.io/3.1.0/manual/">here</a> and <a href="http://metrics.dropwizard.io/3.1.0/manual/third-party/">there</a>). It includes <em>EhCache</em>, <em>Apache Http client</em>, <em>Jetty</em>, etc.
But they are actually many others. Some frameworks, <a href="http://vertx.io/docs/vertx-hawkular-metrics/java/">like Vert.X</a> may also report metrics directly to Hawkular, so you don&#8217;t even need to go through Dropwizard at all (but still, <a href="http://vertx.io/docs/vertx-dropwizard-metrics/java/">you can</a>).</p>
</div>
<div class="paragraph">
<p>Since we&#8217;re already using EhCache in our sample app, let&#8217;s try to get EhCache middleware metrics. We need first to add a maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;io.dropwizard.metrics&lt;/groupId&gt;
      &lt;artifactId&gt;metrics-ehcache&lt;/artifactId&gt;
      &lt;version&gt;3.1.2&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we initialize EhCache programmatically, we create an <code>InstrumentedEhcache</code> object, which is its Dropwizard avatar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    private Benchmark(MetricRegistry registry, Ehcache cache) {
        this.registry = registry;
        ehcache = InstrumentedEhcache.instrument(registry, cache);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we use this <code>InstrumentedCache</code> instead of the initial <code>EhCache</code> object in the rest of our code. That&#8217;s it. Every time something is done on EhCache, metrics will be feeded.</p>
</div>
<div class="paragraph">
<p>See for instance what we get in Grafana, when the <code>EhcacheBackend</code> is invoked during our scenario:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-01-16-dropwizard-ehcache.png" alt="EhCache metrics">
</div>
</div>
<div class="paragraph">
<p><em>Here we track some metrics such as the gets and puts mean, the number of memory hits and misses. See the <a href="http://metrics.dropwizard.io/3.1.0/manual/ehcache/">full list of available metrics</a>.</em></p>
</div>
<div class="paragraph">
<p>What else could we do&#8230;&#8203; We&#8217;re on the JVM, right? We could get monitoring data from MX Beans (such as <code>MemoryMXBean</code>) and create our own metrics in Dropwizard, but there&#8217;s already a module that does the job:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;io.dropwizard.metrics&lt;/groupId&gt;
      &lt;artifactId&gt;metrics-jvm&lt;/artifactId&gt;
      &lt;version&gt;3.1.2&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creating the <code>MetricRegistry</code>, you can add some preset JVM metric sets, such as <code>GarbageCollectorMetricSet</code>, <code>MemoryUsageGaugeSet</code>, <code>ThreadStatesGaugeSet</code> etc.</p>
</div>
<div class="paragraph">
<p>Having them in Hawkular will help you to quickly correlate information, such as an increasing memory heap or non-heap usage related to the use of a cache in our example.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/2017-01-16-dropwizard-jvm.png" alt="JVM metrics">
</div>
</div>
<div class="paragraph">
<p><em>Heap vs non-heap memory used, plus some counters on threads and GC. See the drop in heap memory, at about third quarter of the timeline? It matches the cache eviction in EhCache.</em></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
An interesting fact is that the <em>Cassandra</em> database also exposes metrics through Dropwizard. And <em>Hawkular</em> uses <em>Cassandra</em> internally for metrics storage. Which means that it can be self-monitored with the Hawkular Dropwizard reporter. If you want to read more on this subject, check out <a href="https://wiki.apache.org/cassandra/Metrics">Cassandra metrics</a> and <a href="https://github.com/hawkular/hawkular-dropwizard-reporter#usage-as-an-addthis-plugin-in-cassandra">some instructions here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_fine_tuning_the_reporter">Fine-tuning the reporter</h3>
<div class="sect3">
<h4 id="_tagging">Tagging</h4>
<div class="paragraph">
<p>There are some improvements we can bring to our sample app. First of all, we could tag our metrics.</p>
</div>
<div class="paragraph">
<p>Tagging may not seem very important at first sight, but over time when you get more and more metrics, and when you try to exploit them in a dynamic way, tags become crucial.</p>
</div>
<div class="paragraph">
<p>Even for this sample app, when building the Grafana dashboard we soon want to make it generic so that it can show any other competing implementation of caches. In order to do it, we will create per-metric tags based on regexp. Just by adding a few lines in the <code>HawkularReporter</code> builder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    HawkularReporter hawkularReporter = HawkularReporter.builder(registry, "sample-tenant")
            .addRegexTag(Pattern.compile(GuavaBackend.NAME + "\\..*"), "impl", GuavaBackend.NAME)
            .addRegexTag(Pattern.compile(EhcacheBackend.NAME + "\\..*"), "impl", EhcacheBackend.NAME)
            .addGlobalTag("hostname", hostname)
            .prefixedWith(hostname + ".")
            .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>And as you can see I also added a global tag with the hostname.</p>
</div>
<div class="paragraph">
<p>With that configuration, every metrics whose name starts with <em>"guava."</em> will be tagged <em>"impl:guava"</em>, and similarly for ehcache.
Every metric reported through this reporter will be tagged with the hostname.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filtering">Filtering</h4>
<div class="paragraph">
<p>If you use Grafana with this sample app, you&#8217;ve probably noticed how annoying it is to find and select the metric you want to display,
because it&#8217;s flooded among tons of other metrics. And obviously, the more you store metrics, the more resources will be consumed. So you can filter out metrics you don&#8217;t want.</p>
</div>
<div class="paragraph">
<p>There&#8217;s two kinds of filters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the usual built-in Dropwizard filters, that you can set using <code>HawkularReporterBuilder.filter</code> and by implementing <a href="http://metrics.dropwizard.io/3.1.0/apidocs/com/codahale/metrics/MetricFilter.html">MetricFilter</a></p>
</li>
<li>
<p>another kind of filter that is very specific to the Hawkular reporter, called <em>MetricComposition</em> and for which I must provide some details:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As stated before, <em>Dropwizard</em> has several metric types (gauges, meters, timers etc.), some of them being composed of multiple values. So they don&#8217;t match 1-1 with <em>Hawkular</em> metric types, which are made of simple values (basically, <em>doubles</em> for <em>gauges</em> and <em>longs</em> for <em>counters</em>&#8201;&#8212;&#8201;there are other types but unused in the dropwizard reporter).</p>
</div>
<div class="paragraph">
<p>In order not to loose any piece of data, <em>Dropwizard</em> metrics are <em>exploded</em> into several metrics in <em>Hawkular</em>. For instance, a Meter named <em>guava.cache.read</em> will be translated into 4 gauges (<em>guava.cache.read.1minrt</em>, <em>guava.cache.read.5minrt</em>, <em>guava.cache.read.15minrt</em>, <em>guava.cache.read.meanrt</em>) and 1 counter (<em>guava.cache.read.count</em>) in <em>Hawkular</em>. The full translation table is <a href="https://github.com/hawkular/hawkular-dropwizard-reporter#how-it-works">described here</a>.</p>
</div>
<div class="paragraph">
<p>From the Dropwizard point of view, there is no metric called "guava.cache.read.1minrt". So you cannot filter it out with Dropwizard filters. However you can act on the "metric composition" in the Hawkular reporter. Either by providing the full metric name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    // builder.
      .setMetricComposition("guava.cache.read", Lists.newArrayList("1minrt", "meanrt", "count"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>or using regexp, as I&#8217;m doing in the sample app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    HawkularReporter hawkularReporter = HawkularReporter.builder(registry, "sample-tenant")
            .addRegexTag(Pattern.compile(GuavaBackend.NAME + "\\..*"), "impl", GuavaBackend.NAME)
            .addRegexTag(Pattern.compile(EhcacheBackend.NAME + "\\..*"), "impl", EhcacheBackend.NAME)
            .addGlobalTag("hostname", hostname)
            .prefixedWith(hostname + ".")
            .setRegexMetricComposition(Pattern.compile("net\\.sf\\.ehcache"), Lists.newArrayList("mean", "meanrt", "5minrt", "98perc", "count"))
            .setRegexMetricComposition(Pattern.compile(".*"), Lists.newArrayList("mean", "meanrt", "count"))
            .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we configure all <em>net.sf.ehcache.*</em> metrics (EhCache middleware metrics) to provide their <em>mean</em>, <em>meanrt</em>, <em>5minrt</em>, <em>98perc</em> and <em>count</em> attributes. All other attributes will be discarded.
For all other metrics we only keep <em>mean</em>, <em>meanrt</em> and <em>count</em>.</p>
</div>
<div class="paragraph">
<p>The declaration order matters, since only the first matching pattern will be used for a given metric name.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Using plain string rather than regexp for metric composition is more efficient, since they are internally indexed in a <code>HashMap</code>.
</td>
</tr>
</table>
</div>
<hr>
<div class="paragraph">
<p>That was a quite complete tour of the Hawkular Dropwizard reporter. Some useful links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The sample app used to illustrate this article: <a href="https://github.com/jotak/hawkular-dropwizard-sample" class="bare">https://github.com/jotak/hawkular-dropwizard-sample</a></p>
</li>
<li>
<p>The Grafana dashboard I used (exported json): <a href="https://raw.githubusercontent.com/jotak/hawkular-dropwizard-sample/master/grafana/grafana-dropwizard-sample.json" class="bare">https://raw.githubusercontent.com/jotak/hawkular-dropwizard-sample/master/grafana/grafana-dropwizard-sample.json</a></p>
</li>
<li>
<p>The GitHub page of the reporter itself, along with its documentation, is here: <a href="https://github.com/hawkular/hawkular-dropwizard-reporter" class="bare">https://github.com/hawkular/hawkular-dropwizard-reporter</a></p>
</li>
</ul>
</div>
</div>
</div></p>
            <br />
            <hr /><br />
            <br />
            <a href="blog/2017/01/13/events-aggregation-extension.html"><h1>Extending Complex Event Processing in Hawkular Alerting</h1></a>
            <p>13 January 2017, by Lucas Ponce</p>
            <p><div class="sect1">
<h2 id="_stream_processing_versus_polling_processing">Stream Processing versus Polling Processing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular Alerting uses different techniques to detect behaviours by defining rules.</p>
</div>
<div class="paragraph">
<p>The main implementation is based in a Stream Processing design.
Hawkular Alerting analyzes streams of data and events ordered in a timeline searching for conditions matches.
This technique is also known as Event Processing (or Complex Event Processing) especially when the processing of incoming data might need multiple conditions.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/stream-processing.png" alt="Stream Processing">
</div>
</div>
<div class="paragraph">
<p>This method is particularity good to identify meaningful happenings on complex scenarios and respond to them as quickly as possible.</p>
</div>
<div class="paragraph">
<p>Hawkular Alerting also supports an <em>Alerter</em> based Polling technique that allows periodic processing of defined queries against a backend.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/polling-processing.png" alt="Polling Processing">
</div>
</div>
<div class="paragraph">
<p>This Polling technique is also good in non real time scenarios, for example, to compare historical values in
large range time intervals using statistical operators like averages, medians or percentiles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sliding_windows_on_complex_event_processing">Sliding Windows on Complex Event Processing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An interesting aspect in the logic of detection behaviours is the combination of Stream and Polling processing characteristics.</p>
</div>
<div class="paragraph">
<p>A Sliding Window is a way to define a scope in the stream of data and events received in the timeline.
This Sliding Window lets us define special rules that apply only on the scoped data and events.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/img/blog/2017/sliding-windows.png" alt="Sliding Windows">
</div>
</div>
<div class="paragraph">
<p>A powerful use case is when we can aggregate the scoped events and define expressions on them.<br>
For example, let&#8217;s examine the high level scenarios</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Marketing</strong><br>
<em>Detect when a customer buys several items in a short period of time</em></p>
</li>
<li>
<p><strong>Fraud</strong><br>
<em>Alert when a customer buys from several locations in a short period of time</em></p>
</li>
<li>
<p><strong>Customer loyalty</strong><br>
<em>Detect specific transactions to offer premium discounts to customers</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these scenarios need some sort of aggregation (i.e. aggregate events by customer/transaction id),
define expressions on aggregated fields and scope these events using a Slide Window.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_events_aggregation_extension">Events Aggregation Extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular Alerting has introduced a new <em>Extension</em> called <em>EventsAggregation</em>.<br>
<em>Extensions</em> is a new mechanism to pre-process data or events before they are processed by the core Alerting Engine.</p>
</div>
<div class="paragraph">
<p>The <em>EventsAggregation</em> <em>Extension</em> allows us to scope Sliding Windows on Events and define expressions on aggregated data.
This new feature can be used on <em>Triggers</em> with <em>ExternalCondition</em> and <em>EventsAggregation</em> alerter.</p>
</div>
<div class="paragraph">
<p>For example, we can define a <em>Trigger</em> that represents the <strong>Marketing</strong> scenario previously described:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "triggers":[
    {
      "trigger":{
        "id": "marketing-scenario",
        "name": "Marketing Scenario",
        "description": "Detect when a customer buys several items in a short period of time",
        "severity": "HIGH",
        "enabled": true,
        "actions":[
          {
            "actionPlugin": "email",
            "actionId": "notify-to-marketing"
          }
        ],
        "tags":{
            "HawkularExtension":"EventsAggregation"
        }
      },
      "conditions":[
        {
          "triggerMode": "FIRING",
          "type": "EXTERNAL",
          "alerterId":"EventsAggregation",
          "dataId": "marketing",
          "expression": "event:groupBy(context.accountId):window(time,10s):having(count &gt; 2)"
        }
      ]
    }
  ],
  "actions":[
    {
      "actionPlugin": "email",
      "actionId": "notify-to-marketing",
      "properties": {
        "to": "marketing@hawkular.org"
      }
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression used can be described as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>groupBy(context.accountId)      Group window events by context "accountId" field
window(time,10s)                Define a sliding time window of 10 seconds
having(count &gt; 2)               Define an expression on the grouped events</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, this condition will be true, each time that there are more than two events with the same <em>accountId</em> for a 10 seconds window.</p>
</div>
<div class="paragraph">
<p>In a similar way, we can describe the <strong>Fraud</strong> scenario previously described with the expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">"event:groupBy(tags.accountId):window(time,10s):having(count &gt; 1, count.tags.location &gt; 1)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>groupBy(context.accountId)                    Group window events by context "accountId" field
window(time,10s)                              Define a sliding time window of 10 seconds
having(count &gt; 1, count.tags.location &gt; 1)    Define an expression on the grouped events</code></pre>
</div>
</div>
<div class="paragraph">
<p>This condition will be true when there are more than 1 events with more than one <em>location</em> tag, so detecting when
events for the same <em>accountId</em> happens from different places.</p>
</div>
<div class="paragraph">
<p>The two previous expressions groups all events of the timing window.
We might have scenarios where only specific events should be grouped.</p>
</div>
<div class="paragraph">
<p>For these cases we can add filters into the expressions like in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">"event:groupBy(tags.traceId):filter((category == \"Credit Check\" &amp;&amp; text == \"Exceptionally Good\") || (category == \"Stock Check\" &amp;&amp; text == \"Out of Stock\")):having(count &gt; 1, count.tags.accountId == 1)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This expression will group events filtered by a expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>filter(
    (category == \"Credit Check\" &amp;&amp; text == \"Exceptionally Good\") ||
    (category == \"Stock Check\" &amp;&amp; text == \"Out of Stock\")
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this expression doesn&#8217;t define an explicit sliding time window, so it will use a default expiration window.</p>
</div>
<div class="sect2">
<h3 id="_use_cases">Use cases</h3>
<div class="paragraph">
<p>Stream Processing and Polling Processing might be used for similar scenarios.</p>
</div>
<div class="paragraph">
<p>The EventsAggregation Extension groups Events in memory so it is designed for real time scenarios with relatively short sliding windows.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>EventsAggregation Extension is a useful addition to Hawkular Alerting that will extend the scenarios and type of behaviours that can be detected.</p>
</div>
<div class="paragraph">
<p>In our future work we will enhance this extension covering more use cases (potential aggregation of data).</p>
</div>
<div class="paragraph">
<p>We hope this short introduction helps to show how the EventsAggregation Extension provides powerful new CEP capabilities for Hawkular Alerting.</p>
</div>
<div class="paragraph">
<p>Comments and questions are welcome, here or in <a href="http://webchat.freenode.net/?channels=hawkular">#hawkular</a> room on freenode.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="paragraph">
<div class="title">EventsAggregation Expression syntax:</div>
<p><a href="https://github.com/hawkular/hawkular-alerts/blob/master/hawkular-alerts-engine-extensions/hawkular-alerts-events-aggregation/src/main/java/org/hawkular/alerts/extensions/Expression.java" class="bare">https://github.com/hawkular/hawkular-alerts/blob/master/hawkular-alerts-engine-extensions/hawkular-alerts-events-aggregation/src/main/java/org/hawkular/alerts/extensions/Expression.java</a></p>
</div>
<div class="paragraph">
<div class="title">EventsAggregation examples:</div>
<p><a href="https://github.com/hawkular/hawkular-alerts/blob/master/hawkular-alerts-engine-extensions/hawkular-alerts-events-aggregation/src/test/java/org/hawkular/alerts/extensions/ExpressionTest.java" class="bare">https://github.com/hawkular/hawkular-alerts/blob/master/hawkular-alerts-engine-extensions/hawkular-alerts-events-aggregation/src/test/java/org/hawkular/alerts/extensions/ExpressionTest.java</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/hawkular/hawkular-alerts/blob/master/hawkular-alerts-rest-tests/src/test/groovy/org/hawkular/alerts/rest/EventsAggregationExtensionITest.groovy" class="bare">https://github.com/hawkular/hawkular-alerts/blob/master/hawkular-alerts-rest-tests/src/test/groovy/org/hawkular/alerts/rest/EventsAggregationExtensionITest.groovy</a></p>
</div>
</div>
</div></p>
            <br />
            <hr /><br />
            <br />



    <div class="large-4 columns blog-post-listings">
        <h2>Older posts:</h2>
        <ul>
          <li>04 January 2017 - <a href="blog/2017/01/04/hawkular-metrics-0.23.0.Final-released.html">Hawkular Metrics 0.23.0 - Release</a></li>
          <li>22 December 2016 - <a href="blog/2016/12/22/hawkular-hawkinit-cli-tool.html">Hawkinit</a></li>
          <li>16 December 2016 - <a href="blog/2016/12/16/hawkular-apm-vertx-opentracing-openshift.html">Hawkular APM improvements for OpenShift</a></li>
          <li>06 December 2016 - <a href="blog/2016/12/06/hawkular-metrics-0.22.0.Final-released.html">Hawkular Metrics 0.22.0 - Release</a></li>
          <li>25 November 2016 - <a href="blog/2016/11/25/hawkular-apm-on-openshift.html">Using Hawkular APM on OpenShift</a></li>
          <li>16 November 2016 - <a href="blog/2016/11/16/hawkular-apm-opentracing-js.html">Hawkular APM OpenTracing JavaScript</a></li>
          <li>09 November 2016 - <a href="blog/2016/11/09/hawkular-services-0.20.0.Final.html">Hawkular Services 0.20.0.Final</a></li>
          <li>25 October 2016 - <a href="blog/2016/10/25/hawkular-metrics-0.21.0.Final-released.html">Hawkular Metrics 0.21.0 - Release</a></li>
          <li>24 October 2016 - <a href="blog/2016/10/24/hawkfx-alerts.html">Define Alert Triggers via HawkFX</a></li>
          <li>24 October 2016 - <a href="blog/2016/10/24/hawkular-metrics-openshift-and-grafana.html">Monitoring Microservices with OpenShift, Hawkular Metrics and Grafana</a></li>
          <li>17 October 2016 - <a href="blog/2016/10/17/hawkular-apm-opentracing-and-alerts.html">Hawkular APM supports OpenTracing and Alerts</a></li>
          <li>14 October 2016 - <a href="blog/2016/10/14/hawkular-apm-polyglot-zipkin.html">Hawkular APM Distributed Tracing of Polyglot Application using Zipkin Instrumentations</a></li>
          <li>06 October 2016 - <a href="blog/2016/10/06/hawkular-metrics-0.20.0.Final-released.html">Hawkular Metrics 0.20.0 - Release</a></li>
          <li>19 September 2016 - <a href="blog/2016/09/19/hawkular-apm-on-msa.html">Using Hawkular APM on Red Hat&apos;s Microservices Reference Architecture example</a></li>
          <li>14 September 2016 - <a href="blog/2016/09/14/consuming-hawkular-api-over-ssl.html">Consuming Hawkular API over SSL with self signed certificates</a></li>
          <li>05 September 2016 - <a href="blog/2016/09/05/hawkular-metrics-0.19.0.Final-released.html">Hawkular Metrics 0.19.0 - Release</a></li>
          <li>31 August 2016 - <a href="blog/2016/08/31/spark-metric-analysis.html">Metric Data Analysis using the Apache Spark</a></li>
          <li>11 August 2016 - <a href="blog/2016/08/11/vertx-agent-inventory-impl.html">Vert.x agent inventory implementation</a></li>
          <li>01 August 2016 - <a href="blog/2016/08/01/hawkular-metrics-0.18.0.Final-released.html">Hawkular Metrics 0.18.0 - Release</a></li>
          <li>19 July 2016 - <a href="blog/2016/07/19/android-client-progess.html">What is new in Android Client</a></li>
          <li>14 July 2016 - <a href="blog/2016/07/14/hawkular-apm-openshift.html">Monitoring Application Performance within Openshift</a></li>
          <li>14 July 2016 - <a href="blog/2016/07/14/hawkular-miq.html">Getting started with ManageIQ and Hawkular</a></li>
          <li>13 July 2016 - <a href="blog/2016/07/13/hawkfx.html">Introducing HawkFX</a></li>
          <li>12 July 2016 - <a href="blog/2016/07/12/hawkular-and-jmx-jolokia.html">Hawkular and JMX/Jolokia</a></li>
          <li>12 July 2016 - <a href="blog/2016/07/12/hawkular-and-prometheus.html">Hawkular and Prometheus</a></li>
          <li>06 July 2016 - <a href="blog/2016/07/06/hawkular-metrics-0.17.0.Final-released.html">Hawkular Metrics 0.17.0 - Release</a></li>
          <li>05 July 2016 - <a href="blog/2016/07/05/hawkular-services-0.0.5.Final.html">Hawkular Services 0.0.5.Final</a></li>
          <li>05 July 2016 - <a href="blog/2016/07/05/scaling-hawkular-alerting.html">Scaling stateful services: an example in Hawkular Alerting</a></li>
          <li>27 June 2016 - <a href="blog/2016/06/27/hawkular-apm-0.9-released.html">Hawkular APM 0.9.0.Final Released</a></li>
          <li>14 June 2016 - <a href="blog/2016/06/14/hawkular-services-0.0.2.Final.html">Hawkular Services 0.0.2.Final</a></li>
          <li>01 June 2016 - <a href="blog/2016/06/01/hawkular-btm-to-apm.html">Hawkular BTM component rename</a></li>
          <li>01 June 2016 - <a href="blog/2016/06/01/hawkular-metrics-0.16.0.Final-released.html">Hawkular Metrics 0.16.0 - Release</a></li>
          <li>26 May 2016 - <a href="blog/2016/05/26/hawkular-btm-booker-demo.html">Monitoring Microservices for Application Performance, Distributed Tracing and Business Transactions</a></li>
          <li>24 May 2016 - <a href="blog/2016/05/24/hawkular-btm-ticketmonster-demo.html">Obtaining business metrics without the need to instrument your application</a></li>
          <li>02 May 2016 - <a href="blog/2016/05/02/hawkular-metrics-0.15.0.Final-released.html">Hawkular Metrics 0.15.0 - Release</a></li>
          <li>28 April 2016 - <a href="blog/2016/04/28/new-packaging.html">New Hawkular packaging</a></li>
          <li>27 April 2016 - <a href="blog/2016/04/27/hawkular-inventory-0.15.0.Final-released.html">Hawkular Inventory 0.15.0.Final - Release</a></li>
          <li>22 April 2016 - <a href="blog/2016/04/22/collecting-metrics-from-prometheus-endpoints.html">Collecting Metrics from Prometheus Endpoints</a></li>
          <li>21 April 2016 - <a href="blog/2016/04/21/datamining-first-release.html">Hawkular Data Mining 0.1.0.Final Released</a></li>
          <li>19 April 2016 - <a href="blog/2016/04/19/jmxtrans-to-hawkular-metrics.html">Monitoring JVM applications with jmxtrans</a></li>
          <li>08 April 2016 - <a href="blog/2016/04/08/hawkular-manage-iq-sprint-demo.html">Hawkular in ManageIQ sprint demo(s)</a></li>
          <li>29 March 2016 - <a href="blog/2016/03/29/hawkular-metrics-0.14.0.Final-released.html">Hawkular Metrics 0.14.0 - Release</a></li>
          <li>21 March 2016 - <a href="blog/2016/03/20/qr-android.html">QR Code support for Android Client</a></li>
          <li>16 March 2016 - <a href="blog/2016/03/16/hawkular-metrics-roadmap.html">Hawkular Metrics - Roadmap</a></li>
          <li>15 March 2016 - <a href="blog/2016/03/15/hawkular-1.0.0.Alpha11-released.html">The eleventh milestone of Hawkular released</a></li>
          <li>02 March 2016 - <a href="blog/2016/03/02/hawkular-metrics-0.13.0.Final-released.html">Hawkular Metrics 0.13.0 - Release</a></li>
          <li>23 February 2016 - <a href="blog/2016/02/22/hawkular-manage-iq.html">Integration with ManageIQ</a></li>
          <li>02 February 2016 - <a href="blog/2016/02/02/hawkular-metrics-0.12.0.Final-released.html">Hawkular Metrics 0.12.0 - Release</a></li>
          <li>25 January 2016 - <a href="blog/2016/01/25/hawkular-btm-apm.html">Hawkular-BTM now includes Application Performance Management</a></li>
          <li>21 January 2016 - <a href="blog/2016/01/21/hawkular-1.0.0.Alpha9-released.html">The nineth milestone of Hawkular released</a></li>
          <li>21 January 2016 - <a href="blog/2016/01/21/hawkular-command-gateway-clients.html">Hawkular Command Gateway Clients</a></li>
          <li>20 January 2016 - <a href="blog/2016/01/20/hawkular-datamining-demo-hwk-alpha9.html">Hawkular Data Mining - Predictive Charts</a></li>
          <li>12 January 2016 - <a href="blog/2016/01/12/hawkular-metrics-0.11.0.Final-released.html">Hawkular Metrics 0.11.0 - Release</a></li>
          <li>05 January 2016 - <a href="blog/2016/01/05/we-are-hiring.html">We are hiring !</a></li>
          <li>16 December 2015 - <a href="blog/2015/12/16/hawkular-1.0.0.Alpha8-released.html">The eigth milestone of Hawkular released</a></li>
          <li>01 December 2015 - <a href="blog/2015/12/01/hawkular-btm-instrument-docker-image.html">BTM: Instrumenting an application running from a docker image</a></li>
          <li>30 November 2015 - <a href="blog/2015/11/30/hawkular-btm-0-6-0-released.html">Monitoring Business Transactions in JBoss Ticket Monster App (Part 2)</a></li>
          <li>19 November 2015 - <a href="blog/2015/11/19/hawkular-1.0.0.Alpha7-released.html">Yet another release of Hawkular, the seventh one !</a></li>
          <li>10 November 2015 - <a href="blog/2015/11/10/hawkular-btm-0-5-0-released.html">Monitoring Business Transactions in JBoss Ticket Monster App</a></li>
          <li>30 October 2015 - <a href="blog/2015/10/30/hawkular-metrics-0.8.0.Final-released.html">Hawkular Metrics 0.9.0 - Release</a></li>
          <li>30 October 2015 - <a href="blog/2015/11/30/hawkular-metrics-0.10.0.Final-released.html">Hawkular Metrics 0.10.0 - Release</a></li>
          <li>24 October 2015 - <a href="blog/2015/10/24/hawkular-datamining.html">Introduction to Hawkular Data Mining Module</a></li>
          <li>21 October 2015 - <a href="blog/2015/10/21/hawkular-1.0.0.Alpha6-released.html">The sixth milestone of Hawkular released</a></li>
          <li>12 October 2015 - <a href="blog/2015/10/12/hawkular-metrics-0.8.0.Final-released.html">Hawkular Metrics 0.8.0 - Release</a></li>
          <li>09 October 2015 - <a href="blog/2015/10/09/graph-db-performance.html">Titan Graph DB Performance Tips</a></li>
          <li>06 October 2015 - <a href="blog/2015/10/06/hawkular-btm-0-4-0-released.html">Hawkular-BTM 0.4.0 released</a></li>
          <li>05 October 2015 - <a href="blog/2015/10/05/hawkular-metrics-2k-commits.html">Hawkular Metrics - 2k Commits</a></li>
          <li>30 September 2015 - <a href="blog/2015/09/30/hawkular-metrics-0.7.0.Final-released.html">Hawkular Metrics 0.7.0 - Release</a></li>
          <li>23 September 2015 - <a href="blog/2015/09/23/hawkular-1.0.0.Alpha5-released.html">The fifth milestone of Hawkular released</a></li>
          <li>03 September 2015 - <a href="blog/2015/09/03/monitoring-rails-using-hawkular-metrics.html">Monitoring Rails App using Hawkular Metrics</a></li>
          <li>29 August 2015 - <a href="blog/2015/08/29/hawkular-metrics-0.6.0.Final-released.html">Hawkular Metrics 0.6.0 - Release</a></li>
          <li>27 August 2015 - <a href="blog/2015/08/27/hawkular-1.0.0.Alpha4-released.html">The fourth milestone of Hawkular released</a></li>
          <li>25 August 2015 - <a href="blog/2015/08/25/hawkular-alerts-autoresolve.html">Introduction to AutoResolve triggers</a></li>
          <li>19 August 2015 - <a href="blog/2015/08/19/hawkular-alerts-standalone.html">Using Hawkular Alerts as a standalone engine</a></li>
          <li>14 August 2015 - <a href="blog/2015/08/14/hawkular-btm-0.3.0-demo.html">Visualising Business Transaction Information using Hawkular BTM 0.3.0.Final with RTGov Integration</a></li>
          <li>30 July 2015 - <a href="blog/2015/07/30/hawkular-1.0.0.Alpha3-released.html">Hawkular, all good things make three!</a></li>
          <li>22 July 2015 - <a href="blog/2015/07/22/hawkular-btm-0.2.0-demo.html">Monitoring a Vert.x Application using Hawkular BTM 0.2.0.Final</a></li>
          <li>02 July 2015 - <a href="blog/2015/07/02/hawkular-1.0.0.Alpha2-released.html">Hawkular, the second release!</a></li>
          <li>01 July 2015 - <a href="blog/2015/07/01/hawkular-btm-0-1-0-released.html">Hawkular-BTM 0.1.0 released</a></li>
          <li>01 July 2015 - <a href="blog/2015/07/01/hawkular-btm-0.1.0-demo.html">Monitoring a SwitchYard Application using Hawkular BTM 0.1.0.Final</a></li>
          <li>22 June 2015 - <a href="blog/2015/06/23/hawkular-metrics-0-4-0-released.html">Hawkular Metrics 0.4.0 - Release</a></li>
          <li>17 June 2015 - <a href="blog/2015/06/17/marsjug-and-rivieradev-retrospective.html">MarsJUG and RivieraDEV retrospective</a></li>
          <li>04 June 2015 - <a href="blog/2015/06/04/hawkular-1.0.0.Alpha1-released.html">Hawkular, the first release!</a></li>
          <li>01 June 2015 - <a href="blog/2015/06/01/hawkular-metrics-0-3-4-released.html">Hawkular Metrics 0.3.4 - Release</a></li>
          <li>30 April 2015 - <a href="blog/2015/04/30/introducing-btm.html">Introducing the latest Hawkular component: Business Transaction Management</a></li>
          <li>29 April 2015 - <a href="blog/2015/04/29/hello-to-gsoc-students.html">Hello GSoC Students</a></li>
          <li>17 April 2015 - <a href="blog/2015/04/14/intro-to-hawkular.html">Intro to Hawkular, a middleware open-source management solution</a></li>
          <li>14 April 2015 - <a href="blog/2015/04/14/hawkular-monitor-agent-intro.html">Hawkular-Monitor Agent</a></li>
          <li>09 April 2015 - <a href="blog/2015/04/09/alert-notifiers-for-mobile-devices.html">Alert notifiers for mobile devices</a></li>
          <li>08 April 2015 - <a href="blog/2015/2015-04-08-1.html">Testing collectd integration</a></li>
          <li>07 April 2015 - <a href="blog/2015/2015-04-07-1.html">Hawkular Metrics 0.3.1 - Release</a></li>
          <li>01 April 2015 - <a href="blog/2015/2015-04-01-1.html">Hawkular Discontinued</a></li>
          <li>30 March 2015 - <a href="blog/2015/2015-03-30-1.html">Dockerized Hawkular builds available</a></li>
          <li>24 February 2015 - <a href="blog/2015/2015-02-24-1.html">The Kettle starts boiling</a></li>
          <li>16 February 2015 - <a href="blog/2015/2015-02-16-1.html">Hawkular Metrics 0.2.7 - Release</a></li>
        <br/><br/>
    </div>

    <a href=feed.xml><i class="fa fa-rss"></i> RSS Feed</a>
</div>


		</div>
		<div id="push"></div>
    </div>

    <section class="redhat clearfix">
      <div class="container">
        <p class="pull-left">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="/img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit pull-right">
				  &copy; 2016 | Hawkular is released under <a href="/license.html">Apache License v2.0</a>
					<a href="https://twitter.com/hawkular_org" class="twitter-follow-button" data-show-count="false" data-size="medium">Follow @hawkular_org</a>
				  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
					<iframe src="https://ghbtns.com/github-btn.html?user=hawkular&repo=hawkular-services&type=star" frameborder="0" scrolling="0" class="github-stars-btn"></iframe>
				</p>

    <!--p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p-->
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="js/jbossorg-tabzilla.js"></script>
    <script src="js/behavior.js"></script>
    <script src="js/prettify.js"></script>
    <script src="js//ekko-lightbox.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
